(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=require("@babel/runtime/helpers/defineProperty");var r=e.n(t);const n=require("@babel/runtime/helpers/asyncToGenerator");var a=e.n(n);const s=require("@babel/runtime/regenerator");var i=e.n(s);const c=require("express");var o=e.n(c);const u=require("apollo-server-express"),p=require("path");var l=e.n(p);const d=require("mongoose");var f=e.n(d);const g=require("dotenv"),m=require("jsonwebtoken");var v=e.n(m);(0,g.config)();var w=process.env.JWT_SECRET;const h=function(e){var t=e&&e.headers&&e.headers.authorization,r={auth:!1};if(!t)return r;var n,a=t.split(" ")[1];if(!a)return r;try{n=v().verify(a,w).userId}catch(e){return r}return n?{auth:!0,userId:n}:r},y=require("@babel/runtime/helpers/taggedTemplateLiteral");var b=e.n(y);const x=require("apollo-server");var S;const k=(0,x.gql)(S||(S=b()(["\n  type Filter {\n    id: ID!\n    page: ID!\n    url: String!\n    section: ID!\n    keyWord: String!\n    value: String!\n    date: String!\n  }\n  input InputFilter {\n    keyWord: String!\n    value: String!\n  }\n  input InputFilterEdit {\n    filterId: ID!\n    keyWord: String!\n    value: String!\n  }\n  type PageSection {\n    id: ID!\n    page: ID!\n    url: String!\n    title: String!\n    content: String\n    priority: Int!\n    filters: [Filter]!\n    owner: User!\n    date: String!\n    uploads: [UploadFile]!\n  }\n  type ExtraLink {\n    id: ID!\n    link: String!\n    label: String!\n    content: ID!\n    date: String!\n  }\n  input InputLink {\n    link: String!\n    label: String!\n  }\n  type NewsEvent {\n    id: ID!\n    title: String!\n    content: String!\n    type: String!\n    owner: User!\n    date: String!\n    category: String!\n    dateEvent: String!\n    links: [ExtraLink]!\n    preview: UploadFile\n  }\n  type UploadFile {\n    id: ID!\n    owner: User!\n    date: String!\n    location: String!\n    content: ID\n    type: String!\n    key: String!\n    hashtags: String\n    description: String\n    format: String!\n  }\n  type Page {\n    id: ID!\n    url: String!\n    image: String\n    imageKey: String\n    date: String!\n  }\n  type Msg {\n    type: String!\n    message: String!\n  }\n  type User {\n    id: ID!\n    email: String!\n    ava: String\n    color: String!\n    firstname: String!\n    confirmed: Boolean!\n    lastname: String!\n    middlename: String\n    phone: String\n    address: String\n    birth: String\n    role: String!\n    date: String!\n  }\n  type Auth {\n    userId: String\n    token: String\n  }\n  type Images {\n    images: [UploadFile]!\n    quantity: Int!\n  }\n  type NewsEvents {\n    items: [NewsEvent]!\n    quantity: Int!\n  }\n  type PageSections {\n    items: [PageSection]!\n    quantity: Int!\n  }\n  type SearchContent {\n    images: [UploadFile]!\n    news: [NewsEvent]!\n    events: [NewsEvent]!\n    other: [PageSection]!\n  }\n\n  type Query {\n    searchContent(search: String, tags: String): SearchContent!\n    getUser(userId: String!): User!\n    getAllUsers: [User]!\n    getFilters(url: String!): [Filter]!\n    getPageSections(\n      search: String\n      url: String!\n      filters: [InputFilter]!\n      from: Int!\n      to: Int\n      exceptId: ID\n    ): PageSections!\n    getPageSection(sectionId: ID!): PageSection!\n    getNewsEvents(\n      search: String\n      type: String!\n      category: String\n      dateFrom: String\n      dateTo: String\n      from: Int!\n      to: Int!\n      exceptId: ID\n    ): NewsEvents!\n    getNewsEvent(contentId: ID!, type: String!): NewsEvent!\n    getContentImages(contentId: ID!): [UploadFile]!\n    login(email: String!, password: String!): Auth\n    register(\n      firstname: String!\n      lastname: String!\n      email: String!\n      password: String!\n      isAdmin: Boolean\n      role: String\n    ): Auth\n    getImages(from: Int!, to: Int!, search: String, type: String): Images!\n    getImage(imageId: ID!): UploadFile!\n    getPage(url: String!): Page\n  }\n  type Mutation {\n    setUserAva(image: Upload, deleting: Boolean!): Msg!\n    updateUserData(\n      firstname: String!\n      lastname: String!\n      middlename: String\n      address: String\n      phone: String\n      email: String!\n      password: String\n    ): Msg!\n    sendEmail(\n      firstname: String!\n      lastname: String!\n      email: String!\n      message: String!\n    ): Msg!\n    createPageSection(\n      url: String!\n      title: String!\n      content: String!\n      priority: Int!\n      filters: [InputFilter]!\n      optContent: Boolean\n    ): Msg!\n    editPageSection(\n      sectionId: ID!\n      title: String!\n      content: String!\n      priority: Int!\n      filters: [InputFilterEdit]!\n      optContent: Boolean\n    ): Msg!\n    deletePageSection(sectionId: ID!): Msg!\n    createNewsEvent(\n      title: String!\n      content: String!\n      type: String!\n      category: String!\n      dateEvent: String!\n      links: [InputLink]\n    ): String!\n    editNewsEvent(\n      contentId: ID!\n      title: String!\n      content: String!\n      type: String!\n      category: String!\n      dateEvent: String!\n      links: [InputLink]\n    ): Msg!\n    deleteNewsEvent(contentId: ID!): Msg!\n    createUpload(\n      hashtags: String\n      description: String\n      upload: Upload\n      content: ID\n      type: String\n      mimetype: String\n    ): Msg!\n    editUpload(\n      imageId: ID!\n      hashtags: String\n      description: String\n      upload: Upload\n    ): Msg!\n    deleteUpload(imageId: ID!): Msg!\n    setPageImage(url: String!, image: Upload, deleting: Boolean!): Msg!\n  }\n"])));var E=new d.Schema({email:{type:String,unique:!0,required:!0},password:{type:String,required:!0},ava:{type:String,default:""},color:{type:String,required:!0,default:""},confirmed:{type:Boolean,required:!0,default:"false"},firstname:{type:String,default:"",required:!0},lastname:{type:String,default:"",required:!0},middlename:{type:String,default:""},phone:{type:String,default:""},address:{type:String,default:""},birth:{type:Date,default:""},encrpassword:{type:String,required:!0},role:{type:String,required:!0,default:"user",enum:["user","admin","teacher"]},date:{type:Date,required:!0}});const O=(0,d.model)("User",E);var I=new d.Schema({url:{type:String,required:!0,unique:!0},image:{type:String,default:""},imageKey:{type:String,default:""},date:{type:Date,required:!0}});const j=(0,d.model)("Page",I);var P=new d.Schema({owner:{type:d.Types.ObjectId,ref:"User",required:!0},date:{type:Date,required:!0},location:{type:String,required:!0},content:{type:d.Types.ObjectId},type:{type:String,enum:["image","news","event","other","private"],required:!0},key:{type:String,default:""},description:{type:String,default:""},hashtags:{type:String,default:""},format:{type:String,enum:["image","file"],default:"image"}});const D=(0,d.model)("Upload",P);var q=new d.Schema({title:{type:String,required:!0},content:{type:String,required:!0},type:{type:String,enum:["news","event"],required:!0},owner:{type:d.Types.ObjectId,ref:"User",required:!0},date:{type:String,required:!0},category:{type:String,enum:["ecology","health","sports","science","entertainment","culture"],required:!0},dateEvent:{type:String,required:!0}});const A=(0,d.model)("NewsEvent",q);var U=new d.Schema({link:{type:String,required:!0},label:{type:String,required:!0},content:{type:d.Types.ObjectId,ref:"NewsEvent",required:!0},date:{type:Date,required:!0}});const M=(0,d.model)("ExtraLink",U);var _=new d.Schema({page:{type:d.Types.ObjectId,ref:"Page",required:!0},url:{type:String,required:!0},title:{type:String,required:!0},content:{type:String},priority:{type:Number,required:!0},owner:{type:d.Types.ObjectId,ref:"User",required:!0},filters:[{type:d.Types.ObjectId,ref:"Filter",required:!0}],date:{type:Date,required:!0}});const N=(0,d.model)("PageSection",_);var B=new d.Schema({page:{type:d.Types.ObjectId,ref:"Page",required:!0},url:{type:String,required:!0},section:{type:d.Types.ObjectId,ref:"PageSection",required:!0},keyWord:{type:String,required:!0},value:{type:String,required:!0},date:{type:Date,required:!0}});const W=(0,d.model)("Filter",B),F=require("bcryptjs");var T=e.n(F);function $(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function G(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function C(e,t){return e.value.trim()||e.msg.push(t),e}function L(e,t){return e.value.match(/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/g)||e.msg.push(t),e}function J(e,t,r,n,a){return R.apply(this,arguments)}function R(){return(R=a()(i().mark((function e(t,n,a,s,c){var o,u,p;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,u=c?(o={},r()(o,s,t.value),r()(o,"_id",{$ne:c}),o):r()({},s,t.value),e.next=4,a.find(u);case 4:return e.sent.length&&t.msg.push(n),e.abrupt("return",t);case 9:return e.prev=9,e.t0=e.catch(0),p="Error isUnique: ".concat(e.t0.message),e.abrupt("return",G(G({},t),{},{msg:[p]}));case 13:case"end":return e.stop()}}),e,null,[[0,9]])})))).apply(this,arguments)}function K(e,t){var r=t.min,n=t.max,a=t.minMsg,s=t.maxMsg;return e.value.length<r?e.msg.push(a):e.value.length>n&&e.msg.push(s),e}function V(e,t,r,n){return z.apply(this,arguments)}function z(){return(z=a()(i().mark((function e(t,n,a,s){var c,o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.findOne(r()({},s,t.value));case 3:return(c=e.sent)||t.msg.push(n),e.abrupt("return",{instance:c,field:t});case 8:return e.prev=8,e.t0=e.catch(0),o="Error isContains: ".concat(e.t0.message),e.abrupt("return",{field:G(G({},t),{},{msg:[o]})});case 12:case"end":return e.stop()}}),e,null,[[0,8]])})))).apply(this,arguments)}function Q(e,t,r){return Y.apply(this,arguments)}function Y(){return(Y=a()(i().mark((function e(t,r,n){var a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,T().compareSync(t.value,r)){e.next=5;break}return t.msg.push(n),e.abrupt("return",{passwordVerified:t,isSimilar:!1});case 5:return e.abrupt("return",{passwordVerified:t,isSimilar:!0});case 8:return e.prev=8,e.t0=e.catch(0),a="Compare password error: ".concat(e.t0.message),e.abrupt("return",{passwordVerified:{value:t.value,msg:[a]},isSimilar:!1});case 12:case"end":return e.stop()}}),e,null,[[0,8]])})))).apply(this,arguments)}function H(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function X(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?H(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):H(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Z(){return(Z=a()(i().mark((function e(t){var r,n,a,s,c,o,u,p;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r={},n=!1,Object.keys(t).forEach((function(e){if("exceptId"!==e){var a={value:t[e],msg:[]};r[e]=C(a,"Це поле не може бути порожнім!"),r[e].msg.length&&(n=!0)}})),a=r.firstname,s=r.lastname,c=r.email,o=r.password,!n){e.next=7;break}return e.abrupt("return",{firstname:a,lastname:s,email:c,password:o,isError:n});case 7:if(c=L(c,"Електронна адреса неправильна!"),o=K(o,{min:4,max:50,minMsg:"Пароль повинен містити щонайменше 4 символи!",maxMsg:"Пароль повинен містити не більше 50 символів!"}),!c.msg.length&&!o.msg.length){e.next=11;break}return e.abrupt("return",{email:c,password:o,isError:!0});case 11:return e.next=13,J(r.email,"Ця електронна адреса вже існує, виберіть іншу!",O,"email",t.exceptId);case 13:if(!(c=e.sent).msg.length){e.next=16;break}return e.abrupt("return",{email:c,password:o,isError:!0});case 16:return e.abrupt("return",{email:c,password:o,isError:!1});case 19:return e.prev=19,e.t0=e.catch(0),u="Помилка перевірки полів вводу при реєстрації: ".concat(e.t0.message),p=function(e){return{value:e,msg:[u]}},e.abrupt("return",{email:p(t.email),password:p(t.password),isError:!0});case 24:case"end":return e.stop()}}),e,null,[[0,19]])})))).apply(this,arguments)}function ee(){return(ee=a()(i().mark((function e(t){var r,n,a,s,c,o,u,p,l,d,f,g,m;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r={},n=!1,Object.keys(t).forEach((function(e){r[e]=C({value:t[e],msg:[]},"Це поле не може бути порожнім!"),r[e].msg.length&&(n=!0)})),a=r.email,s=r.password,!n){e.next=7;break}return e.abrupt("return",{email:a,password:s,isError:n});case 7:if(a=L(a,"Електронна адреса неправильна!"),s=K(s,{min:4,max:50,minMsg:"Пароль повинен містити щонайменше 4 символи!",maxMsg:"Пароль повинен містити не більше 50 символів!"}),!a.msg.length&&!s.msg.length){e.next=11;break}return e.abrupt("return",{email:a,password:s,isError:!0});case 11:return e.next=13,V(a,"Ця електронна адреса не існує, виберіть іншу!",O,"email");case 13:if(c=e.sent,o=c.instance,u=c.field,!o){e.next=28;break}return e.next=19,Q(s,o.password,"Пароль неправильний. Будь ласка, спробуйте ще раз!");case 19:if(p=e.sent,l=p.passwordVerified,d=p.isSimilar,f={email:u,password:l},d){e.next=25;break}return e.abrupt("return",X({isError:!0},f));case 25:return e.abrupt("return",X(X({isError:!1},f),{},{instance:o}));case 28:return e.abrupt("return",{email:u,password:s,isError:!0});case 29:e.next=36;break;case 31:return e.prev=31,e.t0=e.catch(0),g="Помилка перевірки полів вводу при авторизації: ".concat(e.t0.message),m=function(e){return{value:e,msg:[g]}},e.abrupt("return",{email:m(t.email),password:m(t.password),isError:!0});case 36:case"end":return e.stop()}}),e,null,[[0,31]])})))).apply(this,arguments)}var te=function(e){return ee.apply(this,arguments)},re=function(e){return Z.apply(this,arguments)},ne=function(){for(var e="#",t=0;t<6;t++)e+="0123456789ABCDEF"[Math.floor(16*Math.random())];return e};const ae=require("sharp");var se=e.n(ae);const ie=require("uuid"),ce=require("@sentry/node"),oe=require("imagemin");var ue=e.n(oe);const pe=require("imagemin-mozjpeg");var le=e.n(pe);const de=require("aws-sdk");var fe=e.n(de);(0,g.config)();var ge=process.env,me=ge.AWS_ID,ve=ge.AWS_SECRET,we=new(fe().S3)({accessKeyId:me,secretAccessKey:ve}),he=function(e,t,r){return{ACL:"public-read",Bucket:r,Key:"".concat((0,ie.v4)(),".").concat(e),Body:t,Conditions:[{acl:"public-read"}]}},ye=function(){var e=a()(i().mark((function e(t,r){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=3;break}return e.next=3,we.deleteObject({Key:t,Bucket:r}).promise();case 3:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),be=function(){var e=a()(i().mark((function e(t){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",se()(t).jpeg().toBuffer());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),xe=function(e){return e.slice(e.lastIndexOf("/")+1,e.length)},Se=function(){var e=a()(i().mark((function e(t,r,n){var a,s,c,o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ue().buffer(t,{plugins:[be,le()({quality:50})]});case 3:return a=e.sent,s=he("".concat(r.slice(0,r.lastIndexOf(".")),".jpeg"),a,n),e.next=7,we.upload(s).promise();case 7:return c=e.sent,o=c.Location,e.abrupt("return",o);case 12:throw e.prev=12,e.t0=e.catch(0),new Error("Uploading buffer to bucket error: ".concat(e.t0.message));case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,r,n){return e.apply(this,arguments)}}(),ke=function(){var e=a()(i().mark((function e(t){var r,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=[],e.next=4,new Promise(function(){var e=a()(i().mark((function e(n){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.createReadStream().on("data",(function(e){r.push(e)})).on("end",(function(){n(Buffer.concat(r))})).on("error",(function(e){ce.captureException(e),n(null)})));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 4:return n=e.sent,e.abrupt("return",n);case 8:throw e.prev=8,e.t0=e.catch(0),new Error("Creating buffer error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t){return e.apply(this,arguments)}}(),Ee=function(){var e=a()(i().mark((function e(t,r){var n,a,s,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.createReadStream(),a=he(t.filename,n,r),e.next=5,we.upload(a).promise();case 5:return s=e.sent,c=s.Location,e.abrupt("return",c);case 10:throw e.prev=10,e.t0=e.catch(0),new Error("Uploading file to bucket error: ".concat(e.t0.message));case 13:case"end":return e.stop()}}),e,null,[[0,10]])})));return function(t,r){return e.apply(this,arguments)}}(),Oe=function(){var e=a()(i().mark((function e(t,r){var n,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t;case 3:if(n=e.sent,!("image"===n.mimetype.split("/")[0])){e.next=14;break}return e.next=8,ke(n);case 8:if(a=e.sent){e.next=11;break}throw new Error("Getting buffer from stream error!");case 11:return e.abrupt("return",Se(a,n.filename,r));case 14:return e.abrupt("return",Ee(n,r));case 15:e.next=20;break;case 17:throw e.prev=17,e.t0=e.catch(0),new Error("Uploading file error: ".concat(e.t0.message));case 20:case"end":return e.stop()}}),e,null,[[0,17]])})));return function(t,r){return e.apply(this,arguments)}}(),Ie=function(){var e=a()(i().mark((function e(t,r){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ye(xe(t),r);case 3:e.next=8;break;case 5:throw e.prev=5,e.t0=e.catch(0),new Error("Deleting file error: ".concat(e.t0.message));case 8:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(t,r){return e.apply(this,arguments)}}(),je=function(){var e=a()(i().mark((function e(t,r,n){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Ie(t,n);case 3:return e.abrupt("return",Oe(r,n));case 6:throw e.prev=6,e.t0=e.catch(0),new Error("Updating file error: ".concat(e.t0.message));case 9:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t,r,n){return e.apply(this,arguments)}}(),Pe={keyWord:"success"},De={keyWord:"error"};(0,g.config)({path:"../../../.env"});var qe=process.env,Ae=qe.UPLOAD,Ue=void 0===Ae?"":Ae,Me=qe.JWT_SECRET,_e=void 0===Me?"":Me,Ne={register:function(e,t){return a()(i().mark((function e(){var r,n,a,s,c,o,u;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,re({firstname:t.firstname,lastname:t.lastname,email:t.email,password:t.password});case 3:if(!(r=e.sent).isError){e.next=6;break}throw new Error(JSON.stringify(r));case 6:return n=r.email,a=T().genSaltSync(12),s=T().hashSync(t.password,a),c=new O({email:n.value,firstname:t.firstname,lastname:t.lastname,middlename:t.middlename,password:s,role:t.role,color:ne(),confirmed:!t.isAdmin&&!0,encrpassword:t.password,date:new Date}),e.next=12,c.save();case 12:if(o=e.sent,!t.isAdmin){e.next=15;break}return e.abrupt("return",{userId:o.id});case 15:return u=v().sign({userId:o._id},_e),e.abrupt("return",{userId:o.id,token:u});case 19:throw e.prev=19,e.t0=e.catch(0),new x.AuthenticationError(e.t0.message);case 22:case"end":return e.stop()}}),e,null,[[0,19]])})))()},login:function(e,t){return a()(i().mark((function e(){var r,n,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,te(t);case 3:if(!(r=e.sent).isError){e.next=6;break}throw new Error(JSON.stringify(r));case 6:return n=r.instance,a=v().sign({userId:null==n?void 0:n._id},_e),e.abrupt("return",{userId:null==n?void 0:n._id,token:a});case 11:throw e.prev=11,e.t0=e.catch(0),new x.AuthenticationError(e.t0.message);case 14:case"end":return e.stop()}}),e,null,[[0,11]])})))()},getUser:function(e,t){return a()(i().mark((function e(){var r,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.userId,e.prev=1,e.next=4,O.findById(r);case 4:return n=e.sent,e.abrupt("return",n);case 8:throw e.prev=8,e.t0=e.catch(1),new Error("Getting user data error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))()},getAllUsers:function(e,t,r){return a()(i().mark((function e(){var t,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.isAuth,e.prev=1,t.auth){e.next=4;break}throw new Error("Access denied!");case 4:return e.next=6,O.find();case 6:return n=e.sent,e.abrupt("return",n);case 10:throw e.prev=10,e.t0=e.catch(1),new Error("Getting all users error: ".concat(e.t0.message));case 13:case"end":return e.stop()}}),e,null,[[1,10]])})))()}},Be={setUserAva:function(e,t,r){return a()(i().mark((function e(){var n,a,s,c,o,u,p;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.image,a=t.deleting,s=r.isAuth,e.prev=2,s.auth){e.next=5;break}throw new Error("Access denied!");case 5:return e.next=7,O.findById(s.userId);case 7:if(!(c=e.sent)){e.next=30;break}if(o="",!a){e.next=16;break}if(!c.ava){e.next=14;break}return e.next=14,Ie(c.ava,Ue);case 14:e.next=28;break;case 16:if(!n){e.next=28;break}if(!c.ava){e.next=24;break}return e.next=20,je(c.ava,n,Ue);case 20:u=e.sent,o=u,e.next=28;break;case 24:return e.next=26,Oe(n,Ue);case 26:p=e.sent,o=p;case 28:return e.next=30,O.findByIdAndUpdate(s.userId,{ava:o});case 30:return e.abrupt("return",{type:Pe.keyWord,message:"Зображення оновлено успішно!"});case 33:throw e.prev=33,e.t0=e.catch(2),new Error("Updating user avatar error: ".concat(e.t0.message));case 36:case"end":return e.stop()}}),e,null,[[2,33]])})))()},updateUserData:function(e,t,r){return a()(i().mark((function e(){var n,a,s,c,o,u,p,l,d,f,g,m,v;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.firstname,a=t.lastname,s=t.middlename,c=t.address,o=t.phone,u=t.email,p=t.password,l=r.isAuth,e.prev=2,l.auth){e.next=5;break}throw new Error("Access denied!");case 5:return e.next=7,O.findById(l.userId);case 7:return d=e.sent,f=p||d.encrpassword,g=f,e.next=12,re({firstname:n,lastname:a,email:u,password:f,exceptId:l.userId||""});case 12:if(!(m=e.sent).isError){e.next=15;break}throw new Error(JSON.stringify(m));case 15:return v=T().genSaltSync(12),f=T().hashSync(f,v),e.next=19,O.findByIdAndUpdate(l.userId,{firstname:n,lastname:a,middlename:s,address:c,phone:o,email:u,password:f,encrpassword:g});case 19:return e.abrupt("return",{type:Pe.keyWord,message:"Дані користувача оновлено успішно!"});case 22:throw e.prev=22,e.t0=e.catch(2),new Error(e.t0.message);case 25:case"end":return e.stop()}}),e,null,[[2,22]])})))()}};(0,g.config)();var We=process.env.UPLOAD,Fe=void 0===We?"":We,Te={getPage:function(e,t){return a()(i().mark((function e(){var r,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.url,e.prev=1,e.next=4,j.findOne({url:r});case 4:return n=e.sent,e.abrupt("return",n);case 8:throw e.prev=8,e.t0=e.catch(1),new Error("Getting page error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))()}},$e={setPageImage:function(e,t,r){return a()(i().mark((function e(){var n,a,s,c,o,u,p,l,d,f;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.url,a=t.image,s=t.deleting,c=r.isAuth,e.prev=2,c.auth){e.next=5;break}throw new Error("Access denied!");case 5:return e.next=7,j.findOne({url:n});case 7:if(o=e.sent){e.next=18;break}if(!a){e.next=13;break}return e.next=12,Oe(a,Fe);case 12:u=e.sent;case 13:return p=new j({url:n,image:u,date:new Date}),e.next=16,p.save();case 16:e.next=39;break;case 18:if(l="",!s){e.next=25;break}if(!o.image){e.next=23;break}return e.next=23,Ie(o.image,Fe);case 23:e.next=37;break;case 25:if(!a){e.next=37;break}if(!o.image){e.next=33;break}return e.next=29,je(o.image,a,Fe);case 29:d=e.sent,l=d,e.next=37;break;case 33:return e.next=35,Oe(a,Fe);case 35:f=e.sent,l=f;case 37:return e.next=39,j.updateOne({url:n},{image:l,date:new Date});case 39:return e.abrupt("return",{type:Pe.keyWord,message:"Зображення оновлено успішно!"});case 42:throw e.prev=42,e.t0=e.catch(2),new Error("Updating image page error: ".concat(e.t0.message));case 45:case"end":return e.stop()}}),e,null,[[2,42]])})))()}};function Ge(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Ce(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ge(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ge(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}(0,g.config)();var Le=process.env.UPLOADS,Je=void 0===Le?"":Le,Re={getImages:function(e,t){return a()(i().mark((function e(){var r,n,a,s,c,o,u,p;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.from,n=t.to,a=t.search,s=t.type,e.prev=1,c=s||{$ne:"private"},o=a?{$text:{$search:a},type:c,format:"image"}:{type:c,format:"image"},e.next=6,D.find(Ce({},o)).sort({date:-1}).skip(r).limit(n);case 6:return u=e.sent,e.next=9,D.find(Ce({},o)).countDocuments();case 9:return p=e.sent,e.abrupt("return",{images:u,quantity:p});case 13:throw e.prev=13,e.t0=e.catch(1),new Error("Getting images errror: ".concat(e.t0.message));case 16:case"end":return e.stop()}}),e,null,[[1,13]])})))()},getImage:function(e,t){return a()(i().mark((function e(){var r,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.imageId,e.prev=1,e.next=4,D.findById(r);case 4:return n=e.sent,e.abrupt("return",n);case 8:throw e.prev=8,e.t0=e.catch(1),new Error("Getting image errror: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))()},getContentImages:function(e,t){return a()(i().mark((function e(){var r,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.contentId,e.prev=1,e.next=4,D.find({content:r});case 4:return n=e.sent,e.abrupt("return",n);case 8:throw e.prev=8,e.t0=e.catch(1),new Error("Getting content images error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))()}},Ke={createUpload:function(e,t,r){return a()(i().mark((function e(){var n,a,s,c,o,u,p,l,d,f,g,m;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.hashtags,a=t.description,s=t.upload,c=t.content,o=t.type,u=t.mimetype,p=void 0===u?"image":u,l=r.isAuth,e.prev=2,l.auth){e.next=5;break}throw new Error("Access denied!");case 5:if(d="image"===p,!s){e.next=26;break}return e.next=9,s;case 9:if(f=e.sent,"image"===f.mimetype.split("/")[0]||!d){e.next=13;break}throw new Error(JSON.stringify({upload:{value:"",msg:["Ви не можете вибрати файл, який не є зображенням!"]}}));case 13:if(!o){e.next=23;break}return e.next=16,Oe(s,Je);case 16:return g=e.sent,m=new D({owner:l.userId,date:new Date,location:g,content:c,type:o,description:a,hashtags:n,format:d?"image":"file"}),e.next=20,m.save();case 20:return e.abrupt("return",{message:"".concat(d?"Зображення":"Файл"," успішно додано!"),type:Pe.keyWord});case 23:throw new Error("Type not specified while creating upload!");case 24:e.next=27;break;case 26:throw new Error(JSON.stringify({upload:{value:"",msg:["Будь-ласка виберіть ".concat(d?"зображення":"файл","!")]}}));case 27:e.next=32;break;case 29:throw e.prev=29,e.t0=e.catch(2),new Error(e.t0.message);case 32:case"end":return e.stop()}}),e,null,[[2,29]])})))()},editUpload:function(e,t,r){return a()(i().mark((function e(){var n,a,s,c,o,u,p,l,d;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.imageId,a=t.hashtags,s=t.description,c=t.upload,o=r.isAuth,e.prev=2,o.auth){e.next=5;break}throw new Error("Access denied!");case 5:return e.next=7,D.findById(n);case 7:if(u=e.sent,p=u.location,!c){e.next=20;break}return e.next=12,c;case 12:if(l=e.sent,"image"===l.mimetype.split("/")[0]||"image"!==u.format){e.next=16;break}throw new Error(JSON.stringify({upload:{value:"",msg:["Ви не можете вибрати файл, який не є зображенням!"]}}));case 16:return e.next=18,je(u.location,c,Je);case 18:d=e.sent,p=d;case 20:return e.next=22,D.findByIdAndUpdate(n,{location:p,hashtags:a,description:s,date:new Date});case 22:return e.abrupt("return",{message:"".concat("image"===u.format?"Зображення":"Файл"," успішно оновлено!"),type:Pe.keyWord});case 25:throw e.prev=25,e.t0=e.catch(2),new Error("Updating upload error: ".concat(e.t0.message));case 28:case"end":return e.stop()}}),e,null,[[2,25]])})))()},deleteUpload:function(e,t,r){return a()(i().mark((function e(){var n,a,s;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.imageId,a=r.isAuth,e.prev=2,a.auth){e.next=5;break}throw new Error("Access denied!");case 5:return e.next=7,D.findById(n);case 7:return s=e.sent,e.next=10,Ie(s.location,Je);case 10:return e.next=12,D.findByIdAndDelete(n);case 12:return e.abrupt("return",{message:"Файл успішно видалено!",type:Pe.keyWord});case 15:throw e.prev=15,e.t0=e.catch(2),new Error("Deleting upload error: ".concat(e.t0.message));case 18:case"end":return e.stop()}}),e,null,[[2,15]])})))()}},Ve=function(){var e=a()(i().mark((function e(t){var r,n,a,s,c,o,u;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r={},n=!1,Object.keys(t).forEach((function(e){var a={value:t[e],msg:[]};r[e]=C(a,"Це поле не може бути порожнім!"),r[e].msg.length&&(n=!0)})),a=r.title,s=r.content,c=r.dateEvent,!n){e.next=7;break}return e.abrupt("return",{title:a,content:s,dateEvent:c,isError:n});case 7:if(!(a=K(a,{min:5,max:150,minMsg:"Заголовок повинен містити принаймні 5 символів!",maxMsg:"Заголовок повинен містити не більше 150 символів!"})).msg.length){e.next=10;break}return e.abrupt("return",{title:a,content:s,dateEvent:c,isError:!0});case 10:return e.abrupt("return",{title:a,content:s,dateEvent:c,isError:!1});case 13:return e.prev=13,e.t0=e.catch(0),o="Помилка перевірки полів вводу при створенні або редагуванні новин або подій: ".concat(e.t0.message),u=function(e){return{value:e,msg:[o]}},e.abrupt("return",{title:u(t.title),content:u(t.title),dateEvent:u(t.title),isError:!0});case 18:case"end":return e.stop()}}),e,null,[[0,13]])})));return function(t){return e.apply(this,arguments)}}();function ze(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Qe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ze(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ze(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}(0,g.config)();var Ye=process.env.UPLOADS,He=void 0===Ye?"":Ye,Xe={getNewsEvents:function(e,t){return a()(i().mark((function e(){var r,n,a,s,c,o,u,p,l,d,f,g;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.search,n=t.type,a=t.category,s=t.dateFrom,c=t.dateTo,o=t.from,u=t.to,p=t.exceptId,e.prev=1,l=s&&c?{$gte:s,$lte:c}:s?{$gte:s}:c?{$lte:c}:{$exists:!0},d=Qe(Qe({},r&&{$text:{$search:r}}),{},{_id:p?{$ne:p}:{$exists:!0},type:n,date:"news"===n?l:{$exists:!0},dateEvent:"event"===n?l:{$exists:!0},category:a||{$exists:!0}}),e.next=7,A.find(d).skip(o).limit(u).sort({date:-1});case 7:return f=e.sent,e.next=10,A.find(d).countDocuments();case 10:return g=e.sent,e.abrupt("return",{items:f,quantity:g});case 14:throw e.prev=14,e.t0=e.catch(1),new Error("Getting news or events error: ".concat(e.t0.message));case 17:case"end":return e.stop()}}),e,null,[[1,14]])})))()},getNewsEvent:function(e,t){return a()(i().mark((function e(){var r,n,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.contentId,n=t.type,e.prev=1,e.next=4,A.findOne({_id:r,type:n});case 4:return a=e.sent,e.abrupt("return",a);case 8:throw e.prev=8,e.t0=e.catch(1),new Error("Getting news or event error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))()}},Ze={createNewsEvent:function(e,t,r){return a()(i().mark((function e(){var n,a,s,c,o,u,p,l,d,f,g,m,v,w,h;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.title,a=t.content,s=t.type,c=t.category,o=t.dateEvent,u=t.links,p=r.isAuth,e.prev=2,p.auth){e.next=5;break}throw new Error("Access denied!");case 5:return e.next=7,Ve({title:n,content:a,dateEvent:o});case 7:if(l=e.sent,d=l.title,f=l.content,g=l.dateEvent,!l.isError){e.next=14;break}throw new Error(JSON.stringify({title:d,content:f,dateEvent:g}));case 14:return m=new A({title:n,content:a,type:s,category:c,dateEvent:o,date:(new Date).toISOString().split("T")[0],owner:p.userId}),e.next=17,m.save();case 17:v=e.sent,w=0;case 19:if(!(w<u.length)){e.next=26;break}return h=new M({link:u[w].link,label:u[w].label,content:v._id,date:new Date}),e.next=23,h.save();case 23:w++,e.next=19;break;case 26:return e.abrupt("return",v._id);case 29:throw e.prev=29,e.t0=e.catch(2),new Error(e.t0.message);case 32:case"end":return e.stop()}}),e,null,[[2,29]])})))()},editNewsEvent:function(e,t,r){return a()(i().mark((function e(){var n,a,s,c,o,u,p,l,d,f,g,m,v,w;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.contentId,a=t.title,s=t.content,c=t.type,o=t.category,u=t.dateEvent,p=t.links,l=r.isAuth,e.prev=2,l.auth){e.next=5;break}throw new Error("Access denied!");case 5:return e.next=7,Ve({title:a,content:s,dateEvent:u});case 7:if(d=e.sent,f=d.title,g=d.content,m=d.dateEvent,!d.isError){e.next=14;break}throw new Error(JSON.stringify({title:f,content:g,dateEvent:m}));case 14:return e.next=16,A.updateOne({_id:n,type:c},{title:a,content:s,category:o,dateEvent:u,date:(new Date).toISOString().split("T")[0]});case 16:return e.next=18,M.deleteMany({content:n});case 18:v=0;case 19:if(!(v<p.length)){e.next=26;break}return w=new M({link:p[v].link,label:p[v].label,content:n,date:new Date}),e.next=23,w.save();case 23:v++,e.next=19;break;case 26:return e.abrupt("return",{message:"".concat("news"===c?"Новина":"Подія"," була успішно оновлена!"),type:Pe.keyWord});case 29:throw e.prev=29,e.t0=e.catch(2),new Error(e.t0.message);case 32:case"end":return e.stop()}}),e,null,[[2,29]])})))()},deleteNewsEvent:function(e,t,r){return a()(i().mark((function e(){var n,a,s,c,o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.contentId,a=r.isAuth,e.prev=2,a.auth){e.next=5;break}throw new Error("Access denied!");case 5:return e.next=7,D.find({content:n});case 7:if(!(s=e.sent).length){e.next=18;break}c=0;case 10:if(!(c<s.length)){e.next=16;break}return e.next=13,Ie(s[c].location,He);case 13:c++,e.next=10;break;case 16:return e.next=18,D.deleteMany({content:n});case 18:return e.next=20,M.deleteMany({content:n});case 20:return e.next=22,A.findById(n);case 22:return o=e.sent,e.next=25,A.findByIdAndDelete(n);case 25:return e.abrupt("return",{message:"".concat("news"===(null==o?void 0:o.type)?"Новина":"Подія"," була успішно видалена!"),type:Pe.keyWord});case 28:throw e.prev=28,e.t0=e.catch(2),new Error("Deleting news or event error: ".concat(e.t0.message));case 31:case"end":return e.stop()}}),e,null,[[2,28]])})))()}},et=function(){var e=a()(i().mark((function e(t){var r,n,a,s,c,o,u,p;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r={},n=!1,Object.keys(t).forEach((function(e){var a={value:String(t[e]),msg:[]};r[e]=C(a,"Це поле не може бути порожнім!"),r[e].msg.length&&(n=!0)})),a=r.title,s=r.content,c=r.priority,o=r.url,!n){e.next=7;break}return e.abrupt("return",{title:a,content:s,priority:c,url:o,isError:n});case 7:if(!(a=K(a,{min:3,max:100,minMsg:"Заголовок повинен містити принаймні 3 символів!",maxMsg:"Заголовок повинен містити не більше 100 символів!"})).msg.length){e.next=10;break}return e.abrupt("return",{title:a,content:s,priority:c,url:o,isError:!0});case 10:return e.abrupt("return",{title:a,content:s,priority:c,url:o,isError:!1});case 13:return e.prev=13,e.t0=e.catch(0),u="Помилка перевірки полів вводу при створенні або редагуванні розділу сторінки: ".concat(e.t0.message),p=function(e){return{value:e,msg:[u]}},e.abrupt("return",{title:p(t.title),content:p(t.title),priority:p(t.title),url:p(t.title),isError:!0});case 18:case"end":return e.stop()}}),e,null,[[0,13]])})));return function(t){return e.apply(this,arguments)}}();function tt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function rt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tt(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}(0,g.config)();var nt=process.env.UPLOADS,at=void 0===nt?"":nt,st={getPageSections:function(e,t){return a()(i().mark((function e(){var r,n,a,s,c,o,u,p,l,d,f,g,m,v;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.search,n=t.url,a=t.filters,s=t.from,c=t.to,o=t.exceptId,e.prev=1,u=r&&{$text:{$search:r}},p=[],l=0,!a.length){e.next=22;break}d=i().mark((function e(t){var r,s,c,o,l;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N.find(rt({url:n},u)).populate({path:"filters",match:{keyWord:a[t].keyWord,value:a[t].value}});case 2:if(r=e.sent,s=[],r.forEach((function(e){e.filters.length&&s.push(e)})),0===t)p=s;else{for(c=[],o=0;o<p.length;o++)for(l=0;l<s.length;l++)String(p[o]._id)===String(s[l]._id)&&c.push(p[o]);p=c}case 6:case"end":return e.stop()}}),e)})),f=0;case 8:if(!(f<a.length)){e.next=13;break}return e.delegateYield(d(f),"t0",10);case 10:f++,e.next=8;break;case 13:return g=[],p.forEach((function(e,t){s<=t&&t<s+c&&g.push(e)})),l=p.length,e.next=18,N.find({_id:{$in:g.map((function(e){return e._id}))}}).populate({path:"filters"});case 18:m=e.sent,p=m,e.next=29;break;case 22:return e.next=24,N.find(rt(rt({_id:o?{$ne:o}:{$exists:!0}},u),{},{url:n})).populate({path:"filters"}).sort({priority:1}).skip(s).limit(c);case 24:return v=e.sent,e.next=27,N.find(rt(rt({},u),{},{url:n})).countDocuments();case 27:l=e.sent,p=v;case 29:return e.abrupt("return",{items:p,quantity:l});case 32:throw e.prev=32,e.t1=e.catch(1),new Error("Getting page sections error: ".concat(e.t1.message));case 35:case"end":return e.stop()}}),e,null,[[1,32]])})))()},searchContent:function(e,t){return a()(i().mark((function e(){var r,n,a,s,c,o,u,p,l,d;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.search,n=t.tags,e.prev=1,a=r&&{$text:{$search:r}},s=n.split(" "),c={images:[],news:[],events:[],other:[]},!s.includes("images")&&n.length){e.next=10;break}return e.next=8,D.find(rt(rt({},a),{},{type:{$ne:"private"},format:"image"})).sort({date:-1}).limit(4);case 8:o=e.sent,c.images=o;case 10:if(!s.includes("news")&&n.length){e.next=15;break}return e.next=13,A.find(rt(rt({},a),{},{type:"news"})).sort({date:-1}).limit(4);case 13:u=e.sent,c.news=u;case 15:if(!s.includes("events")&&n.length){e.next=20;break}return e.next=18,A.find(rt(rt({},a),{},{type:"event"})).sort({date:-1}).limit(4);case 18:p=e.sent,c.events=p;case 20:if(!s.includes("other")&&n.length){e.next=38;break}if(d=N.find(rt({},a)).sort({date:-1}),n.length||r.length){e.next=28;break}return e.next=25,d.limit(10);case 25:l=e.sent,e.next=37;break;case 28:if(r.length){e.next=34;break}return e.next=31,d.limit(10);case 31:l=e.sent,e.next=37;break;case 34:return e.next=36,d;case 36:l=e.sent;case 37:c.other=l;case 38:return e.abrupt("return",c);case 41:throw e.prev=41,e.t0=e.catch(1),new Error("Getting searched content error: ".concat(e.t0.message));case 44:case"end":return e.stop()}}),e,null,[[1,41]])})))()},getPageSection:function(e,t){return a()(i().mark((function e(){var r,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.sectionId,e.prev=1,e.next=4,N.findById(r).populate({path:"filters"});case 4:return n=e.sent,e.abrupt("return",n);case 8:throw e.prev=8,e.t0=e.catch(1),new Error("Getting page section error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))()}},it={createPageSection:function(e,t,r){return a()(i().mark((function e(){var n,a,s,c,o,u,p,l,d,f,g,m,v,w,h,y,b,x,S,k,E,O,I,P;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.title,a=t.content,s=t.priority,c=t.url,o=t.filters,u=t.optContent,p=r.isAuth,e.prev=2,p.auth){e.next=5;break}throw new Error("Access denied!");case 5:return e.next=7,et({title:n,content:u?void 0:a,priority:s,url:c});case 7:if(l=e.sent,d=l.title,f=l.content,g=l.priority,m=l.url,v=l.isError,w={},o.length)for(h=0;h<o.length;h++)o[h].value||(w[o[h].keyWord]={value:o[h].value,msg:["Це поле не може бути порожнім!"]});if(!v&&!Object.keys(w).length){e.next=17;break}throw new Error(JSON.stringify(rt({title:d,content:u?{value:"",msg:[]}:f,priority:g,url:m},w)));case 17:return e.next=19,j.findOne({url:c});case 19:if(y=e.sent){e.next=25;break}return x=new j({url:c,date:new Date}),e.next=24,x.save();case 24:b=e.sent;case 25:return k=new N({page:(S=y||b)._id,title:n,url:c,content:a,priority:s,owner:p.userId,date:new Date}),e.next=29,k.save();case 29:if(E=e.sent,!o.length){e.next=43;break}O=0;case 32:if(!(O<o.length)){e.next=41;break}return I=new W({page:S._id,url:c,section:E._id,keyWord:o[O].keyWord,value:o[O].value,date:new Date}),e.next=36,I.save();case 36:P=e.sent,E.filters.push(P._id);case 38:O++,e.next=32;break;case 41:return e.next=43,E.save();case 43:return e.abrupt("return",{message:"Розділ створено успішно!",type:Pe.keyWord});case 46:throw e.prev=46,e.t0=e.catch(2),new Error(e.t0.message);case 49:case"end":return e.stop()}}),e,null,[[2,46]])})))()},editPageSection:function(e,t,r){return a()(i().mark((function e(){var n,a,s,c,o,u,p,l,d,f,g,m,v,w,h;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.sectionId,a=t.title,s=t.content,c=t.priority,o=t.filters,u=t.optContent,p=r.isAuth,e.prev=2,p.auth){e.next=5;break}throw new Error("Access denied!");case 5:return e.next=7,et({title:a,content:u?void 0:s,priority:c});case 7:if(l=e.sent,d=l.title,f=l.content,g=l.priority,m=l.isError,v={},o.length)for(w=0;w<o.length;w++)o[w].value||(v[o[w].keyWord]={value:o[w].value,msg:["Це поле не може бути порожнім!"]});if(!m&&!Object.keys(v).length){e.next=16;break}throw new Error(JSON.stringify(rt({title:d,content:u?{value:"",msg:[]}:f,priority:g},v)));case 16:return e.next=18,N.findByIdAndUpdate(n,{title:a,content:s,priority:c,date:new Date});case 18:if(!o.length){e.next=26;break}h=0;case 20:if(!(h<o.length)){e.next=26;break}return e.next=23,W.findByIdAndUpdate(o[h].filterId,{value:o[h].value});case 23:h++,e.next=20;break;case 26:return e.abrupt("return",{message:"Розділ оновлено успішно!",type:Pe.keyWord});case 29:throw e.prev=29,e.t0=e.catch(2),new Error(e.t0.message);case 32:case"end":return e.stop()}}),e,null,[[2,29]])})))()},deletePageSection:function(e,t,r){return a()(i().mark((function e(){var n,a,s,c;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.sectionId,a=r.isAuth,e.prev=2,a.auth){e.next=5;break}throw new Error("Access denied!");case 5:return e.next=7,D.find({content:n});case 7:if(!(s=e.sent).length){e.next=18;break}c=0;case 10:if(!(c<s.length)){e.next=16;break}return e.next=13,Ie(s[c].location,at);case 13:c++,e.next=10;break;case 16:return e.next=18,D.deleteMany({content:n});case 18:return e.next=20,W.deleteMany({section:n});case 20:return e.next=22,N.findByIdAndDelete(n);case 22:return e.abrupt("return",{message:"Розділ видалено успішно!",type:Pe.keyWord});case 25:throw e.prev=25,e.t0=e.catch(2),new Error("Deleting page section error: ".concat(e.t0.message));case 28:case"end":return e.stop()}}),e,null,[[2,25]])})))()}},ct={getFilters:function(e,t){return a()(i().mark((function e(){var r,n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.url,e.prev=1,e.next=4,W.find({url:r});case 4:return n=e.sent,e.abrupt("return",n);case 8:throw e.prev=8,e.t0=e.catch(1),new Error("Getting filters error: ".concat(e.t0.message));case 11:case"end":return e.stop()}}),e,null,[[1,8]])})))()}},ot={owner:function(e){return a()(i().mark((function t(){var r,n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.owner,t.prev=1,t.next=4,O.findById(r);case 4:return n=t.sent,t.abrupt("return",n);case 8:throw t.prev=8,t.t0=t.catch(1),new Error("Getting owner to upload error: ".concat(t.t0.message));case 11:case"end":return t.stop()}}),t,null,[[1,8]])})))()}},ut={owner:function(e){return a()(i().mark((function t(){var r,n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.owner,t.prev=1,t.next=4,O.findById(r);case 4:return n=t.sent,t.abrupt("return",n);case 8:throw t.prev=8,t.t0=t.catch(1),new Error("Getting user to news or event error: ".concat(t.t0.message));case 11:case"end":return t.stop()}}),t,null,[[1,8]])})))()},links:function(e){return a()(i().mark((function t(){var r,n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e._id,t.prev=1,t.next=4,M.find({content:r});case 4:return n=t.sent,t.abrupt("return",n);case 8:throw t.prev=8,t.t0=t.catch(1),new Error("Getting extra links to news or event error: ".concat(t.t0.message));case 11:case"end":return t.stop()}}),t,null,[[1,8]])})))()},preview:function(e){return a()(i().mark((function t(){var r,n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e._id,t.prev=1,t.next=4,D.findOne({content:r});case 4:return n=t.sent,t.abrupt("return",n);case 8:throw t.prev=8,t.t0=t.catch(1),new Error("Getting preview image to news or event error: ".concat(t.t0.message));case 11:case"end":return t.stop()}}),t,null,[[1,8]])})))()}},pt={owner:function(e){return a()(i().mark((function t(){var r,n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.owner,t.prev=1,t.next=4,O.findById(r);case 4:return n=t.sent,t.abrupt("return",n);case 8:throw t.prev=8,t.t0=t.catch(1),new Error("Getting user to page section error: ".concat(t.t0.message));case 11:case"end":return t.stop()}}),t,null,[[1,8]])})))()},uploads:function(e){return a()(i().mark((function t(){var r,n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e._id,t.prev=1,t.next=4,D.find({content:r});case 4:return n=t.sent,t.abrupt("return",n);case 8:throw t.prev=8,t.t0=t.catch(1),new Error("Getting uploads to page section error: ".concat(t.t0.message));case 11:case"end":return t.stop()}}),t,null,[[1,8]])})))()}};const lt=require("nodemailer");var dt=e.n(lt);function ft(e){return gt.apply(this,arguments)}function gt(){return(gt=a()(i().mark((function e(t){var r,n,a,s,c,o,u,p;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r={},n=!1,Object.keys(t).forEach((function(e){var a={value:t[e],msg:[]};r[e]=C(a,"Це поле не може бути порожнім!"),r[e].msg.length&&(n=!0)})),a=r.firstname,s=r.lastname,c=r.email,o=r.message,!n){e.next=7;break}return e.abrupt("return",{firstname:a,lastname:s,email:c,message:o,isError:n});case 7:if(c=L(c,"Електронна адреса неправильна!"),o=K(o,{min:5,max:1500,minMsg:"Повідомлення має містити принаймні 5 символів!",maxMsg:"Повідомлення має містити не більше 1500 символів!"}),!c.msg.length&&!o.msg.length){e.next=11;break}return e.abrupt("return",{firstname:a,lastname:s,email:c,message:o,isError:!0});case 11:return e.abrupt("return",{firstname:a,lastname:s,email:c,message:o,isError:!1});case 14:return e.prev=14,e.t0=e.catch(0),u="Помилка перевірки полів вводу при надсиланні повідомлення: ".concat(e.t0.message),p=function(e){return{value:e,msg:[u]}},e.abrupt("return",{firstname:p(t.firstname),lastname:p(t.lastname),email:p(t.email),message:p(t.message),isError:!0});case 19:case"end":return e.stop()}}),e,null,[[0,14]])})))).apply(this,arguments)}(0,g.config)({path:"../../../.env"});var mt={sendEmail:function(e,t){return a()(i().mark((function e(){var r,n,a,s,c,o,u,p,l,d,f;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.firstname,n=t.lastname,a=t.email,s=t.message,e.prev=1,e.next=4,ft({firstname:r,lastname:n,email:a,message:s});case 4:if(c=e.sent,o=c.firstname,u=c.lastname,p=c.email,l=c.message,!c.isError){e.next=12;break}throw new Error(JSON.stringify({firstname:o,lastname:u,email:p,message:l}));case 12:return d="\n        <h2>У вас нове повідомлення!</h2>\n        <h4>Подробиці повідомлення:</h4>\n        <ul>\n          <li>Повне ім'я: ".concat(r," ").concat(n,"</li>\n          <li>Електронна пошта: ").concat(a,"</li>\n        </ul>\n        <h4>Повідомлення:</h4>\n        <p>").concat(s,"</p>"),f=dt().createTransport({service:"gmail",auth:{user:process.env.EMAIL_FROM,pass:process.env.EMAIL_FROM_PASS},tls:{rejectUnauthorized:!1}}),e.next=16,f.sendMail({from:process.env.EMAIL_FROM,to:process.env.EMAIL_TO,subject:"Нове повідомлення",text:"Нове повідомлення",html:d});case 16:if(!e.sent.error){e.next=19;break}return e.abrupt("return",{message:"Помилка надсилання повідомлення!",type:De.keyWord});case 19:return e.abrupt("return",{message:"Повідомлення було успішно надіслано",type:Pe.keyWord});case 22:throw e.prev=22,e.t0=e.catch(1),new Error(e.t0.message);case 25:case"end":return e.stop()}}),e,null,[[1,22]])})))()}};function vt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function wt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?vt(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}const ht={typeDefs:k,resolvers:{Query:wt(wt(wt(wt(wt(wt({},Ne),Te),Re),Xe),st),ct),Mutation:wt(wt(wt(wt(wt(wt({},mt),$e),Ke),Ze),it),Be),UploadFile:ot,NewsEvent:ut,PageSection:pt}},yt=require("cors");var bt=e.n(yt);function xt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function St(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xt(Object(n),!0).forEach((function(t){r()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}(0,g.config)();var kt=process.env,Et=kt.PORT,Ot=kt.MONGO_USER,It=kt.MONGO_PASS,jt=kt.MONGO_DB;a()(i().mark((function e(){var t;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(t=o()()).use(bt()()),e.next=5,f().connect("mongodb+srv://".concat(Ot,":").concat(It,"@cluster0.osxef.mongodb.net/").concat(jt,"?retryWrites=true&w=majority"),{useCreateIndex:!0,useNewUrlParser:!0,useUnifiedTopology:!0,useFindAndModify:!1},(function(){return console.log("MongoDB started successfully!")}));case 5:new u.ApolloServer(St(St({},ht),{},{playground:false,context:function(e){var t=e.req;return{req:t,res:e.res,isAuth:h(t)}}})).applyMiddleware({app:t}),t.use(o().static(l().join(__dirname,"../","client"))),t.get("/*",(function(e,t){t.sendFile(l().join(__dirname,"../","client","index.html"))})),t.listen(Et,(function(){return console.log("Server started on port: ".concat(Et))})),e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),console.error("Server error: ".concat(e.t0.message));case 14:case"end":return e.stop()}}),e,null,[[0,11]])})))()})();